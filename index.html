<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Overlay</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Host+Grotesk:wght@300..800&display=swap');

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: rgba(10, 22, 40, 0);
            font-family: 'Host Grotesk', sans-serif;
        }

        #chat-container {
            padding: 25px;
            max-width: 350px;
            height: 100%;
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            margin: auto;
            scroll-behavior: smooth;
        }

        #chat-container::-webkit-scrollbar {
            display: none;
        }
        
        .small-overlay #chat-container {
            transform: scale(0.6);
        }
        .large-overlay #chat-container {
            transform: scale(1.2);
        }

        .message-container {
            margin-bottom: 15px;
            opacity: 0;
            transform: translateX(-20px);
            animation: slideFadeIn 0.5s ease forwards;
        }

        /* Estilos específicos para cada plataforma */
        .kick-message .message {
            background: rgba(23, 25, 28, 0.9);
            border-left: 4px solid #53fc18;
        }

        .twitch-message .message {
            background: rgba(23, 25, 28, 0.9);
            border-left: 4px solid #9146ff;
        }

        .event-message {
            background: rgba(50, 50, 70, 1);
            padding: 10px;
            border-radius: 10px;
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 10px;
            opacity: 0;
            transform: translateY(20px);
            animation: slideFadeInEvent 0.6s ease forwards;
        }

        /* Estilos para username box */
        .username-box {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            position: absolute;
            top: -15px;
            left: 0px;
            padding: 6px 10px;
            font-weight: 600;
            z-index: 2;
            white-space: nowrap;
            max-width: 90%;
            border-radius: 5px;
            backdrop-filter: blur(5px);
        }

        .kick-message .username-box {
            background: linear-gradient(135deg, rgba(83, 252, 24, 0.9) 0%, rgba(0, 163, 8, 0.9) 100%);
            color: #000;
        }

        .twitch-message .username-box {
            background: linear-gradient(135deg, rgba(145, 70, 255, 0.9) 0%, rgba(92, 22, 197, 0.9) 100%);
            color: #fff;
        }

        /* Avatar do usuário */
        .user-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            object-fit: cover;
        }

        /* Função no canal */
        .user-role {
            padding: 1px 5px;
            border-radius: 3px;
            font-size: 0.7em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .role-broadcaster {
            background: linear-gradient(135deg, #e91916 0%, #ff6b6b 100%);
            color: white;
        }

        .role-moderator {
            background: linear-gradient(135deg, #00b894 0%, #55efc4 100%);
            color: white;
        }

        .role-vip {
            background: linear-gradient(135deg, #fdcb6e 0%, #ffeaa7 100%);
            color: #000;
        }

        .role-subscriber {
            background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
            color: white;
        }

        .badges {
            display: inline-flex;
            align-items: center;
            gap: 3px;
        }

        .badge {
            height: 1.1em;
            width: auto;
            vertical-align: middle;
            border-radius: 3px;
        }

        .channel-badge {
            height: 1.1em;
            width: auto;
            vertical-align: middle;
            border-radius: 2px;
        }

        .message {
            display: inline-block;
            width: calc(100% - 20px);
            background: rgba(23, 25, 28, 0.9);
            padding: 28px 12px 12px 12px;
            margin-top: 22px;
            margin-left: 15px;
            color: rgba(240, 240, 240, 1);
            border-radius: 0 8px 8px 0;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
        }

        .text {
            font-size: clamp(0.85em, 2.5vw, 1em);
            line-height: 1.4;
        }
        
        @keyframes slideFadeIn {
            0% {
                opacity: 0;
                transform: translateX(-30px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideFadeInEvent {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .text img {
            max-width: 1.5em;
            max-height: 1.5em;
            vertical-align: middle;
        }

        /* Ícone da plataforma */
        .platform-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            font-size: 0.7em;
            font-weight: bold;
            border-radius: 3px;
        }

        .kick-icon {
            background: #53fc18;
            color: #000;
        }

        .twitch-icon {
            background: #9146ff;
            color: #fff;
        }

        .channel-badges {
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }

        .donation {
            margin-top: 5px;
            padding: 3px 6px;
            background: linear-gradient(135deg, #ff9f43 0%, #ffd166 100%);
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9em;
            color: #000;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div id="chat-container"></div>
<script>
	const chatContainer = document.getElementById('chat-container');
	
	const urlParams = new URLSearchParams(window.location.search);
	const roomID = urlParams.get("session") || "7RUWtGBfz2";
	const password = "false";
	const featuredMode = false;

	// Função para detectar a plataforma - FORMATO SOCIAL STREAM NINJA
	function detectPlatform(data) {
		// Formato padrão do Social Stream Ninja
		if (data.type) {
			if (data.type.includes('kick') || data.type === 'kick') return 'kick';
			if (data.type.includes('twitch') || data.type === 'twitch') return 'twitch';
		}
		
		// Verificar dados brutos se disponíveis
		if (data.raw) {
			try {
				const rawData = typeof data.raw === 'string' ? JSON.parse(data.raw) : data.raw;
				if (rawData.platform) {
					if (rawData.platform.toLowerCase().includes('kick')) return 'kick';
					if (rawData.platform.toLowerCase().includes('twitch')) return 'twitch';
				}
			} catch(e) {
				console.log("Erro ao analisar dados brutos:", e);
			}
		}
		
		return 'twitch'; // default
	}

	// Função para obter a função do usuário - FORMATO SOCIAL STREAM NINJA
	function getUserRole(data) {
		// Verificar propriedades do Social Stream Ninja
		if (data.owner === true || data.isOwner === true) return 'broadcaster';
		if (data.moderator === true || data.isMod === true) return 'moderator';
		if (data.vip === true || data.isVIP === true) return 'vip';
		if (data.subscriber === true || data.isSubscriber === true) return 'subscriber';
		
		// Verificar badges específicos
		if (data.chatbadges && Array.isArray(data.chatbadges)) {
			for (const badge of data.chatbadges) {
				if (badge.type && badge.type.includes('broadcaster')) return 'broadcaster';
				if (badge.type && badge.type.includes('moderator')) return 'moderator';
				if (badge.type && badge.type.includes('vip')) return 'vip';
				if (badge.type && badge.type.includes('subscriber') || badge.type && badge.type.includes('sub')) return 'subscriber';
			}
		}
		
		// Verificar dados brutos
		if (data.raw) {
			try {
				const rawData = typeof data.raw === 'string' ? JSON.parse(data.raw) : data.raw;
				if (rawData.badges) {
					const badges = rawData.badges;
					if (badges.broadcaster === "1") return 'broadcaster';
					if (badges.moderator === "1") return 'moderator';
					if (badges.vip === "1") return 'vip';
					if (badges.subscriber) return 'subscriber';
				}
			} catch(e) {
				// Ignorar erro
			}
		}
		
		return 'viewer';
	}

	// Função para obter a classe CSS baseada na função
	function getRoleClass(role) {
		switch(role) {
			case 'broadcaster': return 'role-broadcaster';
			case 'moderator': return 'role-moderator';
			case 'vip': return 'role-vip';
			case 'subscriber': return 'role-subscriber';
			default: return '';
		}
	}

	// Função para obter o texto da função
	function getRoleText(role) {
		switch(role) {
			case 'broadcaster': return 'STREAMER';
			case 'moderator': return 'MOD';
			case 'vip': return 'VIP';
			case 'subscriber': return 'SUB';
			default: return '';
		}
	}

	// Função para obter a foto do usuário - FORMATO SOCIAL STREAM NINJA
	function getUserAvatar(data) {
		// Tentar diferentes propriedades comuns
		if (data.avatar && data.avatar.trim() !== '') return data.avatar;
		if (data.profileImage && data.profileImage.trim() !== '') return data.profileImage;
		if (data.userImage && data.userImage.trim() !== '') return data.userImage;
		if (data.picture && data.picture.trim() !== '') return data.picture;
		
		// Verificar dados brutos
		if (data.raw) {
			try {
				const rawData = typeof data.raw === 'string' ? JSON.parse(data.raw) : data.raw;
				if (rawData.avatar) return rawData.avatar;
				if (rawData.profile_image_url) return rawData.profile_image_url;
				if (rawData.user_image) return rawData.user_image;
			} catch(e) {
				// Ignorar erro
			}
		}
		
		// Avatar padrão baseado na plataforma
		const platform = detectPlatform(data);
		if (platform === 'kick') {
			return 'https://kick.com/static/favicon.png';
		} else {
			return 'https://static-cdn.jtvnw.net/user-default-pictures-uv/75305d54-c7cc-40d1-bb9c-91fbe85943c7-profile_image-70x70.png';
		}
	}

	// Função para obter badges do canal - FORMATO SOCIAL STREAM NINJA
	function getChannelBadges(data) {
		let channelBadgesHTML = '';
		
		// Verificar propriedades do Social Stream Ninja
		if (data.channelBadges && Array.isArray(data.channelBadges)) {
			data.channelBadges.forEach(badge => {
				if (badge.src && badge.src.trim() !== '') {
					channelBadgesHTML += `<img class='channel-badge' src='${badge.src}' alt='channel badge' title='${badge.title || ''}' />`;
				}
			});
		}
		
		// Verificar badges customizados nos chatbadges
		if (data.chatbadges && Array.isArray(data.chatbadges)) {
			data.chatbadges.forEach(badge => {
				if (badge.src && badge.src.includes('custom') || badge.src && badge.src.includes('channel')) {
					channelBadgesHTML += `<img class='channel-badge' src='${badge.src}' alt='channel badge' title='${badge.title || ''}' />`;
				}
			});
		}
		
		return channelBadgesHTML;
	}

	// Função para processar badges de chat - FORMATO SOCIAL STREAM NINJA
	function getChatBadges(data) {
		let chatbadgesHTML = '';
		
		if (data.chatbadges && Array.isArray(data.chatbadges)) {
			data.chatbadges.forEach(badge => {
				if (typeof badge === "object" && badge.src) {
					chatbadgesHTML += `<img class='badge' src='${badge.src}' alt='badge' title='${badge.title || ''}' />`;
				} else if (typeof badge === "string") {
					chatbadgesHTML += `<img class='badge' src='${badge}' alt='badge' />`;
				}
			});
		}
		
		// Verificar dados brutos
		if (data.raw && !data.chatbadges) {
			try {
				const rawData = typeof data.raw === 'string' ? JSON.parse(data.raw) : data.raw;
				if (rawData.badges) {
					const badges = rawData.badges;
					for (const [type, version] of Object.entries(badges)) {
						// Gerar URL da badge Twitch
						if (type === 'subscriber') {
							const months = parseInt(version) || 0;
							chatbadgesHTML += `<img class='badge' src='https://static-cdn.jtvnw.net/badges/v1/${version}/${type}.png' alt='${type}' />`;
						}
					}
				}
			} catch(e) {
				// Ignorar erro
			}
		}
		
		return chatbadgesHTML;
	}

	// Função para obter o ícone da plataforma
	function getPlatformIcon(platform) {
		if (platform === 'kick') {
			return '<span class="platform-icon kick-icon">K</span>';
		} else {
			return '<span class="platform-icon twitch-icon">T</span>';
		}
	}

	// Função para aplicar o tamanho do overlay
	function applyOverlaySize() {
		const size = urlParams.get('size');
		document.body.classList.remove("small-overlay", "large-overlay");
		if (size === "small") {
			document.body.classList.add("small-overlay");
		} else if (size === "large") {
			document.body.classList.add("large-overlay");
		}
	}

	function isFullyVisible(element) {
		const containerRect = chatContainer.getBoundingClientRect();
		const elementRect = element.getBoundingClientRect();
		return elementRect.top >= containerRect.top && elementRect.bottom <= containerRect.bottom;
	}

	function removeCutOffMessages() {
		let firstMessage = chatContainer.firstElementChild;
		while (firstMessage && !isFullyVisible(firstMessage)) {
			chatContainer.removeChild(firstMessage);
			firstMessage = chatContainer.firstElementChild;
		}
	}

	function autoScroll() {
		const lastMessage = chatContainer.lastElementChild;
		if (lastMessage) {
			lastMessage.scrollIntoView({ behavior: "instant", block: "end" });
			setTimeout(() => {
				lastMessage.scrollIntoView({ behavior: "instant", block: "end" });
				removeCutOffMessages();
			}, 50);
		}
	}

	const observer = new MutationObserver(() => {
		autoScroll();
	});
	observer.observe(chatContainer, { childList: true, subtree: true });

	function addEventToOverlay(data) {
		const eventDiv = document.createElement('div');
		eventDiv.classList.add('event-message');
		let eventText = '';

		if (data.type === 'follow') {
			eventText = `${data.chatname} just followed!`;
		} else if (data.type === 'subscription') {
			eventText = `${data.chatname} subscribed!`;
		} else if (data.type === 'donation') {
			eventText = `${data.chatname} donated ${data.amount || ''}!`;
		}

		eventDiv.innerHTML = `<div>${eventText}</div>`;
		chatContainer.appendChild(eventDiv);
	}

	function addMessageToOverlay(data) {
		console.log("Dados recebidos:", data); // DEBUG
		
		if (!data) {
			console.error("Dados vazios");
			return;
		}

		// Verificar se é uma mensagem de chat válida
		if (!data.chatname && !data.username && !data.user) {
			console.log("Ignorando mensagem sem nome de usuário:", data);
			return;
		}

		const userName = data.chatname || data.username || data.user || 'Anonymous';
		
		if (!data.chatmessage && !data.message && !data.text) {
			console.log("Ignorando mensagem sem texto:", data);
			return;
		}

		const messageText = data.chatmessage || data.message || data.text || '';

		// Skip meta-only messages
		if (userName === 'Anonymous' && data.meta) {
			return;
		}

		if (['follow', 'subscription', 'donation'].includes(data.type)) {
			addEventToOverlay(data);
			return;
		}

		// Detectar plataforma
		const platform = detectPlatform(data);
		
		// Obter informações do usuário
		const userRole = getUserRole(data);
		const roleClass = getRoleClass(userRole);
		const roleText = getRoleText(userRole);
		const userAvatar = getUserAvatar(data);
		const channelBadges = getChannelBadges(data);
		const chatBadges = getChatBadges(data);
		
		// Criar um novo contêiner de mensagem
		const messageContainer = document.createElement('div');
		messageContainer.classList.add('message-container', `${platform}-message`);
		
		const messageDiv = document.createElement('div');
		messageDiv.classList.add('message');

		// Construir HTML da mensagem
		messageDiv.innerHTML = `
			<div class="username-box">
				<img class="user-avatar" src="${userAvatar}" alt="${userName}'s avatar" onerror="this.src='https://static.vecteezy.com/system/resources/previews/009/292/244/non_2x/default-avatar-icon-of-social-media-user-vector.jpg'" />
				${getPlatformIcon(platform)}
				<span>${userName}</span>
				${roleText ? `<span class="user-role ${roleClass}">${roleText}</span>` : ''}
				${chatBadges ? `<span class="badges">${chatBadges}</span>` : ''}
				${channelBadges ? `<span class="channel-badges">${channelBadges}</span>` : ''}
			</div>
			<div class="text">${messageText}</div>
			${(data.donation || data.hasDonation) ? `<div class="donation">${(data.donation || data.hasDonation)}</div>` : ''}
		`;

		messageContainer.appendChild(messageDiv);
		chatContainer.appendChild(messageContainer);

		// Limpar mensagens antigas se houver muitas
		const maxMessages = 50;
		while (chatContainer.children.length > maxMessages) {
			chatContainer.removeChild(chatContainer.firstChild);
		}
	}
	
	const iframe = document.createElement("iframe");
	iframe.src = featuredMode
		? `https://vdo.socialstream.ninja/?ln&password=${password}&salt=vdo.ninja&label=overlay&exclude=${roomID}&scene&novideo&noaudio&cleanoutput&room=${roomID}`
		: `https://vdo.socialstream.ninja/?ln&salt=vdo.ninja&password=${password}&push&label=dock&vd=0&ad=0&novideo&noaudio&autostart&cleanoutput&room=${roomID}`;

	iframe.style.cssText = "width: 0px; height: 0px; position: fixed; left: -100px; top: -100px;";
	document.body.appendChild(iframe);

	window.addEventListener("message", (event) => {
		console.log("Mensagem recebida do iframe:", event.data); // DEBUG
		if (event.source !== iframe.contentWindow) return;
		if (event.data.dataReceived && event.data.dataReceived.overlayNinja) {
			addMessageToOverlay(event.data.dataReceived.overlayNinja);
		}
		// Também tentar processar dados diretos
		else if (event.data.chatname || event.data.username) {
			addMessageToOverlay(event.data);
		}
	});

	document.addEventListener('DOMContentLoaded', () => {
		applyOverlaySize();
	});
		
	// WebSocket mode alternative
	var conCon = 1;
	var socketserver = false;
	var serverURL = urlParams.has("localserver") ? "ws://127.0.0.1:3000" : "wss://io.socialstream.ninja";

	function setupSocket(){
		socketserver.onclose = function (){
			setTimeout(function(){
				conCon+=1;
				socketserver = new WebSocket(serverURL);
				setupSocket();
			},100*conCon);
		};
		socketserver.onopen = function (){
			conCon = 1;
			socketserver.send(JSON.stringify({"join":roomID, "out":3, "in":4}));
		};
		socketserver.addEventListener('message', function (event) {
			console.log("Dados WebSocket:", event.data); // DEBUG
			var resp = false
			if (event.data){
				try {
					var data = JSON.parse(event.data);
					addMessageToOverlay(data);
					if (data.get){
						var ret = {};
						ret.callback = {};
						ret.callback.get = data.get
						ret.callback.result = true;
						socketserver.send(JSON.stringify(ret));
					}
				} catch(e) {
					console.error("Erro ao processar dados WebSocket:", e);
				}
			}
		});
	}
	
	if (urlParams.has("server") || urlParams.has("server2")){
		serverURL = urlParams.get("server") ||  urlParams.get("server2") || serverURL;
		socketserver = new WebSocket(serverURL);
		setupSocket();
	}

	// Limpar chat a cada 10 minutos para evitar acúmulo excessivo
	setInterval(() => {
		const maxMessages = 30;
		while (chatContainer.children.length > maxMessages) {
			chatContainer.removeChild(chatContainer.firstChild);
		}
	}, 600000);
</script>
</body>
</html>
