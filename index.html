<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Chat Overlay</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Host+Grotesk:wght@400;600;800&display=swap');

html, body {
    margin: 0;
    padding: 0;
    background: transparent;
    font-family: 'Host Grotesk', sans-serif;
}

#chat-container {
    width: 420px;
    padding: 20px;
}

/* ===================== MENSAGEM ===================== */

.message-container {
    margin-bottom: 18px;
    animation: slideIn 0.4s ease forwards;
}

.message {
    background: rgba(15,15,18,0.92);
    border-left: 5px solid var(--platform-color);
    border-radius: 10px;
    padding: 18px 14px 12px;
    box-shadow: 0 0 15px rgba(0,0,0,.6);
}

/* ===================== USERNAME ===================== */

.username-box {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
    font-weight: 700;
    font-size: 0.95em;
    color: var(--name-color);
}

/* ===================== BADGES ===================== */

.badges img {
    height: 16px;
}

/* ===================== TEXTO ===================== */

.text {
    color: #eee;
    font-size: 0.9em;
    line-height: 1.4;
    word-wrap: break-word;
}

/* ===================== PLATAFORMAS ===================== */

.platform-twitch { --platform-color: #9146ff; }
.platform-kick   { --platform-color: #53fc18; }

/* ===================== DESTAQUES ===================== */

.role-mod .message {
    border-left-color: #ff2e2e;
    box-shadow: 0 0 18px rgba(255,46,46,.6);
}

.role-vip .message {
    border-left-color: #ff6ad5;
}

.role-sub .message {
    border-left-color: gold;
}

.role-owner .message {
    border-left-color: red;
    box-shadow: 0 0 25px rgba(255,0,0,.8);
}

/* ===================== ANIMAÇÃO ===================== */

@keyframes slideIn {
    from { opacity: 0; transform: translateX(-15px); }
    to   { opacity: 1; transform: translateX(0); }
}
</style>

<script src="./chroma.min.cjs"></script>
</head>

<body>
<div id="chat-container"></div>

<script>
const chat = document.getElementById("chat-container");
const params = new URLSearchParams(window.location.search);
const ROOM = params.get("session") || "4DP7Stjuew";
const SERVER = "wss://io.socialstream.ninja";

let socket;

/* ===================== CONEXÃO ===================== */

function connect() {
    socket = new WebSocket(SERVER);

    socket.onopen = () => {
        socket.send(JSON.stringify({ join: ROOM, out: 3, in: 4 }));
    };

    socket.onmessage = e => {
        const data = JSON.parse(e.data);
        renderMessage(data);
    };

    socket.onclose = () => setTimeout(connect, 2000);
}

/* ===================== DETECÇÕES ===================== */

function detectPlatform(data) {
    if (data.type?.includes("kick")) return "kick";
    return "twitch";
}

function detectRole(data) {
    if (!data.chatbadges) return "";
    const badges = data.chatbadges.map(b => b.src || "").join(" ");
    if (badges.includes("broadcaster")) return "role-owner";
    if (badges.includes("moderator")) return "role-mod";
    if (badges.includes("vip")) return "role-vip";
    if (badges.includes("subscriber")) return "role-sub";
    return "";
}

/* ===================== RENDER ===================== */

function renderMessage(data) {
    if (!data.chatname || !data.chatmessage) return;

    const platform = detectPlatform(data);
    const role = detectRole(data);

    const userColor = data.chatcolor || "#ffffff";

    let badgesHTML = "";
    (data.chatbadges || []).forEach(b => {
        if (b.src) badgesHTML += `<img src="${b.src}">`;
    });

    const el = document.createElement("div");
    el.className = `message-container platform-${platform} ${role}`;
    el.style.setProperty("--name-color", userColor);

    el.innerHTML = `
        <div class="message">
            <div class="username-box">
                <span>${data.chatname}</span>
                <span class="badges">${badgesHTML}</span>
            </div>
            <div class="text">${data.chatmessage}</div>
        </div>
    `;

    chat.appendChild(el);

    while (chat.children.length > 40) {
        chat.removeChild(chat.firstChild);
    }
}

connect();
</script>
</body>
</html>
